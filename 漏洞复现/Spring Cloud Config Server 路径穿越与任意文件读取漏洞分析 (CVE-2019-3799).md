# Spring Cloud Config Server 路径穿越与任意文件读取漏洞分析 - 【CVE-2019-3799】

[toc]

> [Spring Cloud Config Server 路径穿越与任意文件读取漏洞分析 - 【CVE-2019-3799】 - 先知社区 (aliyun.com)](https://xz.aliyun.com/t/4844)

## 影响版本

[CVE-2019-3799: Directory Traversal with spring-cloud-config-server | Security | VMware Tanzu](https://tanzu.vmware.com/security/cve-2019-3799)

![image-20220112141529322](Spring%20Cloud%20Config%20Server%20%E8%B7%AF%E5%BE%84%E7%A9%BF%E8%B6%8A%E4%B8%8E%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%20(CVE-2019-3799).assets/image-20220112141529322.png)

## 环境搭建

```bash
# clone环境
git clone https://github.com/spring-cloud/spring-cloud-config.git
# 版本回退 v2.1.1
git reset --hard 60858110
# quick start， 需要配置JAVA_HOME
cd spring-cloud-config-server
../mvnw spring-boot:run
```

> ERROR:
>
> * [错误: 找不到或无法加载主类 org.apache.maven.wrapper.MavenWrapperMain](https://www.cnblogs.com/daivid/p/12744119.html)
> * [工具类应隐藏 public 构造器。 [HideUtilityClassConstructor]](https://blog.csdn.net/ahence/article/details/51378880)

我这里试了好几次都不行，一直报`Failed during checkstyle execution`，check不通过。

解决方法：

1. 就把`src`和`pom.xml`放进IDEA里面，然后慢慢排除错误（加JavaDoc加到吐）。

2. 禁用`maven-checkstyle-plugin`。

    ```xml
    <build>
        <plugins>
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-checkstyle-plugin</artifactId>
                <!--            <configuration>-->
                <!--                <skip>true</skip>-->
                <!--            </configuration>-->
                <executions>
                    <execution>
                        <id>checkstyle-validation</id>
                        <phase>none</phase>
                    </execution>
                </executions>
            </plugin>
        </plugins>
    </build>
    ```

能跑起来但是还有好多问题：

* 连接超时
* Read超时
* 不能fetch：`Could not fetch remote for master remote: https://github.com/spring-cloud-samples/config-repo`

甚至同样的操作会有不同的报错。

> 原因1：在19年的时候`label`默认是`master`，但是现在github上的`label`默认是`main`，所以直接访问`http://localhost:8888/foo/development`不能成功。可以选择将所有的`master`都改成`main`，也可以在后面指定`main`。(下面的第一张图片展示了1处，一共有5处。)
>
> ![image-20220112221529064](Spring%20Cloud%20Config%20Server%20%E8%B7%AF%E5%BE%84%E7%A9%BF%E8%B6%8A%E4%B8%8E%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%20(CVE-2019-3799).assets/image-20220112221529064.png)
>
> ![image-20220112230241485](Spring%20Cloud%20Config%20Server%20%E8%B7%AF%E5%BE%84%E7%A9%BF%E8%B6%8A%E4%B8%8E%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%20(CVE-2019-3799).assets/image-20220112230241485.png)
>
> 原因2：将`/resources/configserver.yml`里面的`spring.cloud.config.server.git.uri`的后面加`.git`，要不然可能会访问出错。（`basedir`可加可不加）
>
> ```yml
> info:
> 	component: Config Server
> spring:
>     application:
>          name: configserver
> 	autoconfigure.exclude: org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration
> 	jmx:
>  		default_domain: cloud.config.server
> 	cloud:
>  		config:
>    			server:
>      			git:
> 					basedir: F:\MyProjects\IDEA\demo\tmp
>                    	uri: https://github.com/spring-cloud-samples/config-repo.git
>                    	repos:
>                     	- patterns: multi-repo-demo-*
>                           uri: https://github.com/spring-cloud-samples/config-repo
> 
> server:
>       port: 8888
> management:
>       context_path: /admin
> ```
> 原因3（次要原因）：连接不到github，这时请挂梯子。在maven安装主目录里的`conf/settings.xml`里配置。
>

## 漏洞复现

跑起来之后，访问`http://127.0.0.1:8888/foo/label/main/test.json`。（这里指定了`label`是`main`）

多试几次，直到访问成功，因为很有可能访问不成功。访问成功证明已经没问题了，可以进行漏洞复现。

> Spring Cloud Config是Spirng Cloud下用于分布式配置管理的组件，分为`Config-Server`和`Config-Client`两个角色。 `Config-Server`负责集中存储/管理配置文件，`Config-Client`则可以从`Config-Server`提供的HTTP接口获取配置文件使用。2019年4月16日，Pivotal官方发布安全通告，Spring Cloud Config Server 部分版本存在目录遍历漏洞，据此可以获取Server端服务器文件。
>
> 根据[官方文档](https://cloud.spring.io/spring-cloud-static/spring-cloud.html#_serving_plain_text)，可以通过如下请求`GET /{name}/{profile}/{label}/{path}` 来获取配置文件，`name`，`profile`和`label`的含义与常规环境下的endpoint相同，而`path`是指文件名。以官方示例为环境，我们请求 https://github.com/spring-cloud-samples/config-repo/blob/master/test.json 这个文件并以文本形式返回 ，则我们需要向`Spring Cloud Config Server`发出如下请求：
>
> ```http
> GET http://127.0.0.1:8888/foo/label/master/test.json
> ```

构造报文：

```http
GET http://127.0.0.1:8888/foo/label/main/..%252Fpom.xml HTTP/1.1
Host: 127.0.0.1:8888
```

根据请求格式可以在 `org/springframework/cloud/config/server/resource/ResourceController.java:71` 中找到对应的处理 `@RequestMapping("/{name}/{profile}/{label}/**")`：

![image-20220113113742171](Spring%20Cloud%20Config%20Server%20%E8%B7%AF%E5%BE%84%E7%A9%BF%E8%B6%8A%E4%B8%8E%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%20(CVE-2019-3799).assets/image-20220113113742171.png)

其中`path`值即为payload: `..%2fpom.xml`

跟入`retrieve` 在`org/springframework/cloud/config/server/resource/ResourceController.java:107` ：

![image-20220113113845796](Spring%20Cloud%20Config%20Server%20%E8%B7%AF%E5%BE%84%E7%A9%BF%E8%B6%8A%E4%B8%8E%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%20(CVE-2019-3799).assets/image-20220113113845796.png)

可以看到这里`locations`的值为`file:/F:\MyProjects\IDEA\demo\tmp`，这是`Config-Server`从后端拉取到配置文件时临时存放，正常情况下将会在该文件夹下进行文件的查找，比如`test.json`。

![image-20220113113945962](Spring%20Cloud%20Config%20Server%20%E8%B7%AF%E5%BE%84%E7%A9%BF%E8%B6%8A%E4%B8%8E%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%20(CVE-2019-3799).assets/image-20220113113945962.png)

不过我们传入的却是`..%2fpom.xml`，最终拼接出来的文件url即为：

![image-20220113114124291](Spring%20Cloud%20Config%20Server%20%E8%B7%AF%E5%BE%84%E7%A9%BF%E8%B6%8A%E4%B8%8E%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%20(CVE-2019-3799).assets/image-20220113114124291.png)

返回后获取到的`resource`即为`F:\MyProjects\IDEA\demo\pom.xml`，调用`StreamUtils.copyToString(is, Charset.forName("UTF-8")`读取到文件内容：

![image-20220113114326900](Spring%20Cloud%20Config%20Server%20%E8%B7%AF%E5%BE%84%E7%A9%BF%E8%B6%8A%E4%B8%8E%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%20(CVE-2019-3799).assets/image-20220113114326900.png)
